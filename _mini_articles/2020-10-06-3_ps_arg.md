---
title: "#3 ps program arguments can be changed"
tags: ["mini"]
---

If you change the value of argv inside a program, `/proc/<pid>/cmdline` and `ps` will reflect that

```c
int main(int argc, char *argv[]) {
    if(argc != 3) {
        printf("I want 3 arguments");
        return -1;
    }

    memcpy(argv[0], "hidden_prog", strlen(argv[0]));
    memcpy(argv[1], "xxxxxxxxxxxxxxxx", strlen(argv[1]));
    memcpy(argv[2], "yyyyyyyyyyyyyyyy", strlen(argv[2]));

    sleep(1000);
    return 0;
}
```

Running on one terminal `./my_program arg1 arg2` and then `ps a -o args | grep hidden` we get:
```
hidden_prog  xxxx yyyy
```

Running `cat /proc/<pid>/cmdline` we also get `hidden_prog\x00xxxx\x00yyyy`.

## Getting the real program name
`ps` has the `c` option which as the manual says:
 > Show the true command name. This is derived from the name of the executable file, rather than from the argv value. Command arguments and any modifications to them are thus not shown.

We get the real binary name, but not we cannot get the original `argv`.

`ps auxc | grep my_program`
```
jofra     8997  0.0  0.0   4380   724 pts/4    S+   14:26   0:00 my_program
```

`cat /proc/<pid>/comm` also returns the original program name: `my_program`.

## Does ps use proc?
Fake name: `strace -- ps p <pid> -o args 2>&1 | grep -A 2 <pid>`
```
openat(AT_FDCWD, "/proc/18025/cmdline", O_RDONLY) = 6
read(6, "hidden_prog\0\0xxxx\0yyyy\0", 131072) = 23
```

Real name: `strace -- ps p <pid> c 2>&1 | grep -A 2 <pid>`
```
openat(AT_FDCWD, "/proc/18025/stat", O_RDONLY) = 6
read(6, "18025 (my_program) S 14032 18025"..., 2048) = 320
openat(AT_FDCWD, "/proc/18025/status", O_RDONLY) = 6
read(6, "Name:\tmy_program\nUmask:\t0002\nSta"..., 2048) = 1366
```

Not `/proc/<pid>/comm` but the true command name appears in multiple `proc` files.
